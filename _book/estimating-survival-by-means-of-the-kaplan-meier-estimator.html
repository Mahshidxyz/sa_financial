<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>A short course on Survival Analysis applied to the Financial Industry</title>
  <meta name="description" content="This is a short course on survival analysis applied to the financial field.">
  <meta name="generator" content="bookdown 0.5.4 and GitBook 2.6.7">

  <meta property="og:title" content="A short course on Survival Analysis applied to the Financial Industry" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a short course on survival analysis applied to the financial field." />
  <meta name="github-repo" content="sestelo/sa_financial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="A short course on Survival Analysis applied to the Financial Industry" />
  
  <meta name="twitter:description" content="This is a short course on survival analysis applied to the financial field." />
  

<meta name="author" content="Marta Sestelo">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="km.html">
<link rel="next" href="pointwise-confidence-interval-for-st.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">A short course on Survival Analysis</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="programing-language-and-software.html"><a href="programing-language-and-software.html"><i class="fa fa-check"></i>Programing language and software</a></li>
<li class="chapter" data-level="" data-path="main-references-and-credits.html"><a href="main-references-and-credits.html"><i class="fa fa-check"></i>Main references and credits</a></li>
<li class="chapter" data-level="" data-path="about-the-author.html"><a href="about-the-author.html"><i class="fa fa-check"></i>About the Author</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro-what.html"><a href="intro-what.html"><i class="fa fa-check"></i><b>1.1</b> What is survival analysis?</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro-what.html"><a href="intro-what.html#time-time-origen-time-scale-event"><i class="fa fa-check"></i><b>1.1.1</b> Time, time origen, time scale, event</a></li>
<li class="chapter" data-level="1.1.2" data-path="intro-what.html"><a href="intro-what.html#goals-of-the-survival-analysis"><i class="fa fa-check"></i><b>1.1.2</b> Goals of the survival analysis</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro-censor.html"><a href="intro-censor.html"><i class="fa fa-check"></i><b>1.2</b> Censoring</a></li>
<li class="chapter" data-level="1.3" data-path="intro-notation.html"><a href="intro-notation.html"><i class="fa fa-check"></i><b>1.3</b> Some notation</a></li>
<li class="chapter" data-level="1.4" data-path="intro-functions.html"><a href="intro-functions.html"><i class="fa fa-check"></i><b>1.4</b> Survival/hazard functions</a></li>
<li class="chapter" data-level="1.5" data-path="relation-between-functions.html"><a href="relation-between-functions.html"><i class="fa fa-check"></i><b>1.5</b> Relation between functions</a></li>
<li class="chapter" data-level="1.6" data-path="intro-distri.html"><a href="intro-distri.html"><i class="fa fa-check"></i><b>1.6</b> Some common distributions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="km.html"><a href="km.html"><i class="fa fa-check"></i><b>2</b> Kaplan Meier estimator</a><ul>
<li class="chapter" data-level="2.1" data-path="estimating-survival-by-means-of-the-kaplan-meier-estimator.html"><a href="estimating-survival-by-means-of-the-kaplan-meier-estimator.html"><i class="fa fa-check"></i><b>2.1</b> Estimating survival by means of the Kaplan Meier estimator</a><ul>
<li class="chapter" data-level="2.1.1" data-path="estimating-survival-by-means-of-the-kaplan-meier-estimator.html"><a href="estimating-survival-by-means-of-the-kaplan-meier-estimator.html#other-representation"><i class="fa fa-check"></i><b>2.1.1</b> Other representation</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="pointwise-confidence-interval-for-st.html"><a href="pointwise-confidence-interval-for-st.html"><i class="fa fa-check"></i><b>2.2</b> Pointwise confidence interval for <span class="math inline">\(S(t)\)</span></a></li>
<li class="chapter" data-level="2.3" data-path="comparing-survival-curves.html"><a href="comparing-survival-curves.html"><i class="fa fa-check"></i><b>2.3</b> Comparing survival curves</a></li>
<li class="chapter" data-level="2.4" data-path="pros-and-cons-of-the-kaplan-meirs-estimator.html"><a href="pros-and-cons-of-the-kaplan-meirs-estimator.html"><i class="fa fa-check"></i><b>2.4</b> Pros and Cons of the Kaplan-Meirs estimator</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cox.html"><a href="cox.html"><i class="fa fa-check"></i><b>3</b> The Cox Proportional Hazards Model</a><ul>
<li class="chapter" data-level="3.1" data-path="the-semiparametric-model.html"><a href="the-semiparametric-model.html"><i class="fa fa-check"></i><b>3.1</b> The semiparametric model</a></li>
<li class="chapter" data-level="3.2" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>3.2</b> Estimation</a></li>
<li class="chapter" data-level="3.3" data-path="computing-the-hazard-ratio.html"><a href="computing-the-hazard-ratio.html"><i class="fa fa-check"></i><b>3.3</b> Computing the Hazard Ratio</a></li>
<li class="chapter" data-level="3.4" data-path="hypothesis-testing.html"><a href="hypothesis-testing.html"><i class="fa fa-check"></i><b>3.4</b> Hypothesis testing</a></li>
<li class="chapter" data-level="3.5" data-path="adjusting-survival-curves.html"><a href="adjusting-survival-curves.html"><i class="fa fa-check"></i><b>3.5</b> Adjusting Survival Curves</a></li>
<li class="chapter" data-level="3.6" data-path="how-to-evaluate-the-ph-assumption.html"><a href="how-to-evaluate-the-ph-assumption.html"><i class="fa fa-check"></i><b>3.6</b> How to evaluate the PH assumption?</a><ul>
<li class="chapter" data-level="3.6.1" data-path="how-to-evaluate-the-ph-assumption.html"><a href="how-to-evaluate-the-ph-assumption.html#graphical-approach"><i class="fa fa-check"></i><b>3.6.1</b> Graphical approach</a></li>
<li class="chapter" data-level="3.6.2" data-path="how-to-evaluate-the-ph-assumption.html"><a href="how-to-evaluate-the-ph-assumption.html#goodness-of-fit-test"><i class="fa fa-check"></i><b>3.6.2</b> Goodness-of-fit test</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="non-proportional-hazards-and-now-what.html"><a href="non-proportional-hazards-and-now-what.html"><i class="fa fa-check"></i><b>3.7</b> Non-Proportional Hazards… and now what?</a><ul>
<li class="chapter" data-level="3.7.1" data-path="non-proportional-hazards-and-now-what.html"><a href="non-proportional-hazards-and-now-what.html#an-example-stratified-proportional-hazards-models"><i class="fa fa-check"></i><b>3.7.1</b> An example… Stratified Proportional Hazards Models</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="why-cox-ph-model-is-so-popular-pros-of-the-model.html"><a href="why-cox-ph-model-is-so-popular-pros-of-the-model.html"><i class="fa fa-check"></i><b>3.8</b> Why Cox PH model is so popular? (pros of the model)</a></li>
<li class="chapter" data-level="3.9" data-path="bonus-track-1-additive-cox-model.html"><a href="bonus-track-1-additive-cox-model.html"><i class="fa fa-check"></i><b>3.9</b> Bonus track 1: Additive Cox model</a></li>
<li class="chapter" data-level="3.10" data-path="bonus-track-2-machine-learning-for-estimating-the-cox-pm-model.html"><a href="bonus-track-2-machine-learning-for-estimating-the-cox-pm-model.html"><i class="fa fa-check"></i><b>3.10</b> Bonus track 2: Machine Learning for estimating the Cox PM model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="joint-models-for-longitudinal-and-time-to-event-data.html"><a href="joint-models-for-longitudinal-and-time-to-event-data.html"><i class="fa fa-check"></i><b>4</b> Joint Models for Longitudinal and Time-to-Event Data</a><ul>
<li class="chapter" data-level="4.1" data-path="linear-mixed-models.html"><a href="linear-mixed-models.html"><i class="fa fa-check"></i><b>4.1</b> Linear Mixed Models</a></li>
<li class="chapter" data-level="4.2" data-path="estimation-of-the-joint-model.html"><a href="estimation-of-the-joint-model.html"><i class="fa fa-check"></i><b>4.2</b> Estimation of the Joint Model</a></li>
<li class="chapter" data-level="4.3" data-path="the-jm-package.html"><a href="the-jm-package.html"><i class="fa fa-check"></i><b>4.3</b> The <code>JM</code> package</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="condsurv.html"><a href="condsurv.html"><i class="fa fa-check"></i><b>5</b> Conditinal Survival with <code>condSURV</code></a><ul>
<li class="chapter" data-level="5.1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="notation.html"><a href="notation.html"><i class="fa fa-check"></i><b>5.2</b> Notation</a></li>
<li class="chapter" data-level="5.3" data-path="estimation-of-the-conditional-survival.html"><a href="estimation-of-the-conditional-survival.html"><i class="fa fa-check"></i><b>5.3</b> Estimation of the conditional survival</a><ul>
<li class="chapter" data-level="5.3.1" data-path="estimation-of-the-conditional-survival.html"><a href="estimation-of-the-conditional-survival.html#kaplan-meier-weighted-estimator-kmw"><i class="fa fa-check"></i><b>5.3.1</b> Kaplan-Meier Weighted Estimator (<code>KMW</code>)</a></li>
<li class="chapter" data-level="5.3.2" data-path="estimation-of-the-conditional-survival.html"><a href="estimation-of-the-conditional-survival.html#the-landmark-approach-ldm"><i class="fa fa-check"></i><b>5.3.2</b> The Landmark approach (<code>LDM</code>)</a></li>
<li class="chapter" data-level="5.3.3" data-path="estimation-of-the-conditional-survival.html"><a href="estimation-of-the-conditional-survival.html#the-presmoothed-landmark-approach-pldm"><i class="fa fa-check"></i><b>5.3.3</b> The Presmoothed Landmark approach (<code>PLDM</code>)</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="the-condsurv-package.html"><a href="the-condsurv-package.html"><i class="fa fa-check"></i><b>5.4</b> The <code>condSURV</code> package</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-install.html"><a href="appendix-install.html"><i class="fa fa-check"></i><b>A</b> Installation of <code>R</code> and <code>RStudio</code></a></li>
<li class="chapter" data-level="B" data-path="appendix-rstudio.html"><a href="appendix-rstudio.html"><i class="fa fa-check"></i><b>B</b> Introduction to <code>RStudio</code></a></li>
<li class="chapter" data-level="C" data-path="appendix-r.html"><a href="appendix-r.html"><i class="fa fa-check"></i><b>C</b> Introduction to <code>R</code></a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A short course on Survival Analysis applied to the Financial Industry</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimating-survival-by-means-of-the-kaplan-meier-estimator" class="section level2">
<h2><span class="header-section-number">2.1</span> Estimating survival by means of the Kaplan Meier estimator</h2>
<p>If there are no censored observations in a sample of dimension <span class="math inline">\(n\)</span>, the most natural estimator for survival is the <strong>empirical estimator</strong>, given by</p>
<p><span class="math display">\[
\hat S(t) = P(T \gt t) = \frac{1}{n} \sum_{i=1}^{n} I(t_i \gt t)
\]</span> that is, the proportion of observations with failure times greater than <span class="math inline">\(t\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">11</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">17</span>, <span class="dv">22</span>, <span class="dv">23</span>)
<span class="kw">sum</span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">8</span><span class="op">/</span><span class="kw">length</span>(n)) <span class="co"># hat S(8) </span>
## [1] 8
<span class="kw">sum</span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">12</span><span class="op">/</span><span class="kw">length</span>(n)) <span class="co"># hat S(12) </span>
## [1] 4</code></pre></div>
<p>Another option for estimating survival could be to use the hazard:</p>
<p><span class="math display">\[
\hat S(t) = \prod_{k = 1}^{t-1} \bigg [ 1- \hat \lambda(k)\bigg] \quad {\text{where}} \quad  \hat \lambda(t) = \frac{\sum_{i=1}^{n} I(Y_i = t)}{\sum_{i=1}^{n} I (Y_i \ge t)} 
\]</span></p>
<p>Note that <span class="math inline">\(\hat \lambda(t)\)</span> is obtained as the number of individuals that die at time <span class="math inline">\(t\)</span> divided by the number of individuals that survive to <span class="math inline">\(t\)</span>, the number of individuals at risk at time <span class="math inline">\(t\)</span> (using the death as event).</p>
<p>However, alternative methods are necessary to incorporate censoring (censored times are different than event times).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#  preprocesing data</span>

<span class="kw">head</span>(loan)[, <span class="kw">c</span>(<span class="dv">51</span>, <span class="dv">65</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">19</span>, <span class="dv">18</span>, <span class="dv">50</span>)]
##                   LoanKey LoanOriginationDate LoanStatus
## 1 E33A3400205839220442E84 2007-09-12 00:00:00  Completed
## 2 9E3B37071505919926B1D82 2014-03-03 00:00:00    Current
## 3 6954337960046817851BCB2 2007-01-17 00:00:00  Completed
## 4 A0393664465886295619C51 2012-11-01 00:00:00    Current
## 5 A180369302188889200689E 2013-09-20 00:00:00    Current
## 6 C3D63702273952547E79520 2013-12-24 00:00:00    Current
##            ClosedDate    Occupation BorrowerState StatedMonthlyIncome
## 1 2009-08-14 00:00:00         Other            CO            3083.333
## 2                      Professional            CO            6125.000
## 3 2009-12-17 00:00:00         Other            GA            2083.333
## 4                     Skilled Labor            GA            2875.000
## 5                         Executive            MN            9583.333
## 6                      Professional            NM            8333.333
<span class="kw">table</span>(loan<span class="op">$</span>LoanStatus)
## 
##              Cancelled             Chargedoff              Completed 
##                      5                  11992                  38074 
##                Current              Defaulted FinalPaymentInProgress 
##                  56576                   5018                    205 
##   Past Due (&gt;120 days)   Past Due (1-15 days)  Past Due (16-30 days) 
##                     16                    806                    265 
##  Past Due (31-60 days)  Past Due (61-90 days) Past Due (91-120 days) 
##                    363                    313                    304

<span class="co"># removing duplicates</span>
loan_nd &lt;-<span class="st"> </span>loan[<span class="kw">unique</span>(loan<span class="op">$</span>LoanKey), ] 

<span class="co"># removing LoanStatus no needed </span>
sel_status  &lt;-<span class="st"> </span>loan_nd<span class="op">$</span>LoanStatus <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Completed&quot;</span>, <span class="st">&quot;Current&quot;</span>, 
                                          <span class="st">&quot;ChargedOff&quot;</span>, <span class="st">&quot;Defaulted&quot;</span>, 
                                          <span class="st">&quot;Cancelled&quot;</span>)
loan_filtered &lt;-<span class="st"> </span>loan_nd[sel_status, ]

<span class="co"># creating status variable for censoring</span>
loan_filtered<span class="op">$</span>status &lt;-<span class="st"> </span><span class="kw">ifelse</span>(
  loan_filtered<span class="op">$</span>LoanStatus <span class="op">==</span><span class="st"> &quot;Defaulted&quot;</span> <span class="op">|</span>
<span class="st">    </span>loan_filtered<span class="op">$</span>LoanStatus <span class="op">==</span><span class="st"> &quot;Chargedoff&quot;</span>,  <span class="dv">1</span>, <span class="dv">0</span>)

<span class="co"># adding the final date to &quot;current&quot; status</span>
<span class="kw">head</span>(<span class="kw">levels</span>(loan_filtered<span class="op">$</span>ClosedDate))
## [1] &quot;&quot;                    &quot;2005-11-25 00:00:00&quot; &quot;2005-11-29 00:00:00&quot;
## [4] &quot;2005-11-30 00:00:00&quot; &quot;2005-12-08 00:00:00&quot; &quot;2005-12-28 00:00:00&quot;
<span class="kw">levels</span>(loan_filtered<span class="op">$</span>ClosedDate)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;2014-11-03 00:00:00&quot;</span>

<span class="co"># creating the time-to-event variable</span>
loan_filtered<span class="op">$</span>start &lt;-<span class="st"> </span><span class="kw">as.Date</span>(loan_filtered<span class="op">$</span>LoanOriginationDate)
loan_filtered<span class="op">$</span>end &lt;-<span class="st"> </span><span class="kw">as.Date</span>(loan_filtered<span class="op">$</span>ClosedDate)
loan_filtered<span class="op">$</span>time &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">difftime</span>(loan_filtered<span class="op">$</span>end, loan_filtered<span class="op">$</span>start, <span class="dt">units =</span> <span class="st">&quot;days&quot;</span>))

<span class="co"># there is an error in the data (time to event less than 0)</span>
loan_filtered &lt;-<span class="st"> </span>loan_filtered[<span class="op">-</span>loan_filtered<span class="op">$</span>time <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, ]

<span class="co"># just considering a year of loans creation</span>
ii &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">as.Date</span>(loan_filtered<span class="op">$</span>LoanOriginationDate),<span class="st">&#39;%Y&#39;</span>) <span class="op">%in%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">c</span>(<span class="st">&quot;2006&quot;</span>)
loan_filtered &lt;-<span class="st"> </span>loan_filtered[ii, ] 


<span class="kw">dim</span>(loan_filtered)
## [1] 4923   85
<span class="kw">head</span>(loan_filtered)[, <span class="kw">c</span>(<span class="dv">51</span>, <span class="dv">65</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">19</span>, <span class="dv">18</span>, <span class="dv">50</span>, <span class="dv">83</span>, <span class="dv">84</span>, <span class="dv">85</span>)]
##                       LoanKey LoanOriginationDate LoanStatus
## 55706 569F3376160094112B0CCBC 2006-12-07 00:00:00  Completed
## 5258  E3C433749566192177F6A25 2006-11-21 00:00:00  Completed
## 64330 3E5A33783711441966A924A 2006-12-29 00:00:00  Completed
## 1485  AC4533744391314602B8E3A 2006-12-07 00:00:00  Completed
## 22540 08B63364821540522E94FD2 2006-06-13 00:00:00  Completed
## 50637 31C9337247671326054DF29 2006-11-03 00:00:00  Completed
##                ClosedDate   Occupation BorrowerState StatedMonthlyIncome
## 55706 2009-07-27 00:00:00 Professional                          4534.250
## 5258  2008-07-03 00:00:00        Other                          3833.333
## 64330 2009-12-29 00:00:00       Doctor                         18083.333
## 1485  2008-11-21 00:00:00        Other            IN            4576.000
## 22540 2007-09-05 00:00:00                                       3458.333
## 50637 2009-11-03 00:00:00 Professional            IN           15666.667
##            start        end time
## 55706 2006-12-07 2009-07-27  963
## 5258  2006-11-21 2008-07-03  590
## 64330 2006-12-29 2009-12-29 1096
## 1485  2006-12-07 2008-11-21  715
## 22540 2006-06-13 2007-09-05  449
## 50637 2006-11-03 2009-11-03 1096

<span class="co">#------</span>



<span class="co"># censoring status 0 = censored, 1 = no censored (default)</span>
<span class="kw">table</span>(loan_filtered<span class="op">$</span>status)
## 
##    0    1 
## 3560 1363
<span class="kw">prop.table</span>(<span class="kw">table</span>(loan_filtered<span class="op">$</span>status))
## 
##         0         1 
## 0.7231363 0.2768637


<span class="co"># median time until default (taking into account just no cendored data)</span>
<span class="kw">median</span>(loan_filtered<span class="op">$</span>time[loan_filtered<span class="op">$</span>status<span class="op">==</span><span class="dv">1</span>])  <span class="co"># I&#39;m underestimating</span>
## [1] 333


<span class="co"># median time until default (with all data)</span>
<span class="kw">mean</span>(loan_filtered<span class="op">$</span>time)  <span class="co"># I&#39;m underestimating the median survival too </span>
## [1] 633.4331
<span class="co"># (in censored times, the real time is bigger)</span></code></pre></div>
<p><span class="citation">Kaplan and Meier (<a href="#ref-KM58">1958</a>)</span> obtained a nonparametric estimate of the survival function, called product-limit, which is the generalization of the empirical estimator for censored data</p>
<p><span class="math display">\[
\hat S(t) = P(T \gt t) = \prod_{i:t_i \le t} \bigg[1-\frac{d_i}{n_i} \bigg]
\]</span> where <span class="math inline">\(t_1, t_2, \ldots,t_n\)</span> are the observed event times, <span class="math inline">\(d_i\)</span> is the number of events at time <span class="math inline">\(t_i\)</span>, and <span class="math inline">\(n_i\)</span> is the number of individuals at risk at time <span class="math inline">\(t_i\)</span> (i.e, the original sample minus all those who had the event before <span class="math inline">\(t_j\)</span>.)</p>
<p>Note that <span class="math inline">\(d_i/n_i\)</span> is the proportion that failed at the event time <span class="math inline">\(t_i\)</span> and <span class="math inline">\(1 - d_i/n_i\)</span> is the proportion surviving the event time <span class="math inline">\(t_j\)</span>.</p>
<p>The Kaplan-Meier estimate is a step function with jumps at event times. The size of the steps depend on the number of events and the number of individuals at risk at the corresponding time. Note that if the last data is censored, the estimator will not reach the zero value.</p>
<p>Without censoring, the estimator is equivalent to the empirical survival function <span class="math inline">\(\hat S(t) = \frac{1}{n} \sum_{i=1}^{n} I(t_i \gt t)\)</span> or to the one using the risk estimates <span class="math inline">\(\hat S(t) = \prod_{k = 1}^{t-1} \bigg [ 1- \hat \lambda(k)\bigg]\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">km &lt;-<span class="st"> </span><span class="kw">survfit</span>(<span class="kw">Surv</span>(time, status) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> loan_filtered)
km  <span class="co"># we can see the correct estimated median</span>
## Call: survfit(formula = Surv(time, status) ~ 1, data = loan_filtered)
## 
##       n  events  median 0.95LCL 0.95UCL 
##    4923    1363    1189    1158    1217
<span class="kw">print</span>(km, <span class="dt">print.rmean =</span> <span class="ot">TRUE</span>)
## Call: survfit(formula = Surv(time, status) ~ 1, data = loan_filtered)
## 
##          n     events     *rmean *se(rmean)     median    0.95LCL 
##    4923.00    1363.00     926.53       6.85    1189.00    1158.00 
##    0.95UCL 
##    1217.00 
##     * restricted mean with upper limit =  1224</code></pre></div>

<div class="rmdexercise_sestelo">
Take a look at <code>?Surv</code> of the survival package.
</div>

<div id="other-representation" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Other representation</h3>
<p>Assume that <span class="math inline">\(\widetilde T_i = min (T_i, C_i)\)</span> and <span class="math inline">\(\Delta_i = I (T_i \le C_i)\)</span>, we introduce a weighted average representation of the Kaplan-Meier estimator which will be used later to introduce estimators for the conditional survival function</p>
<span class="math display">\[\begin{equation*}
\widehat S(y)=1-\sum_{i=1}^{n}W_{i}I(\widetilde T_{(i)}\leq y),
\end{equation*}\]</span>
<p>where <span class="math inline">\(\widetilde T_{\left( 1\right) }\leq ...\leq \widetilde T_{\left( n\right) }\)</span> denotes the ordered <span class="math inline">\(\widetilde T\)</span>-sample and</p>
<span class="math display">\[\begin{equation*}
W_{i}=\frac{\Delta_{\left[ i\right] }}{n-i+1}\prod_{j=1}^{i-1}\left[ 1-\frac{%
\Delta _{\left[ j\right] }}{n-j+1}\right]
\end{equation*}\]</span>
<p>is the Kaplan-Meier weight attached to <span class="math inline">\(\widetilde T_{\left( i\right) }\)</span>. In the expression of <span class="math inline">\(W_{i}\)</span> notation <span class="math inline">\(\Delta_{\left[ i\right] }\)</span> is used for the <span class="math inline">\(i\)</span>-th concomitant value of the censoring indicator (that is, <span class="math inline">\(\Delta_{\left[ i \right] }=\Delta _{j}\)</span> if <span class="math inline">\(\widetilde T_{\left( i\right) }=\widetilde T_{j}\)</span>).</p>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-KM58">
<p>Kaplan, E.L., and P. Meier. 1958. “Nonparametric Estimation from Incomplete Observations.” <em>Journal of the American Statistical Association</em> 53: 457–81.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="km.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="pointwise-confidence-interval-for-st.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/sestelo/sa_financial/edit/master/03_kaplan_meier.Rmd",
"text": "Edit"
},
"download": ["bookdown.pdf", "bookdown.epub"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
